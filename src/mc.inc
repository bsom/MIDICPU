; MIDI CPU
; copyright John Staskevich, 2017
; john@codeandcopper.com
;
; This work is licensed under a Creative Commons Attribution 4.0 International License.
; http://creativecommons.org/licenses/by/4.0/
;
; mc.inc
;
; Main include file.
;
; =================================
;
; Functions
;
; =================================

;	EXTERN	isr


; =================================
;
; Variables
;
; =================================

	EXTERN	DIGITAL_0
	EXTERN	DIGITAL_1
	EXTERN	DIGITAL_2
; Analog input states (14)
	EXTERN	ANALOG_0
	EXTERN	ANALOG_1
	EXTERN	ANALOG_2
	EXTERN	ANALOG_3
	EXTERN	ANALOG_4
	EXTERN	ANALOG_5
	EXTERN	ANALOG_6
	EXTERN	ANALOG_7
	EXTERN	ANALOG_8
	EXTERN	ANALOG_9
	EXTERN	ANALOG_10
	EXTERN	ANALOG_11
	EXTERN	ANALOG_12
	EXTERN	ANALOG_13
; Switch matrix input states (24)
; have now been moved to INCOMING_SYSEX_C
;	EXTERN	KEYS_0X

; Encoder input states (12)
	EXTERN	MULTI_0
	EXTERN	MULTI_1
	EXTERN	MULTI_2
	EXTERN	MULTI_3
	EXTERN	MULTI_4
	EXTERN	MULTI_5
	EXTERN	MULTI_6
	EXTERN	MULTI_7
	EXTERN	MULTI_8
	EXTERN	MULTI_9
	EXTERN	MULTI_10
	EXTERN	MULTI_11
; Configuration Layer Control
	EXTERN	LAYER_FLAGS
	EXTERN	LAYER_BITMASK
	EXTERN	LAYER_FLAGS_SNAPSHOT
; Locally generated outbound message
	EXTERN	LOCAL_STATUS
	EXTERN	LOCAL_D0
	EXTERN	LOCAL_D1	
	EXTERN	LOCAL_SYSEX_FLAGS
; Locally generated message registers
	EXTERN	LAST_NOTE_NUM
	EXTERN	LAST_NOTE_VELOCITY
	EXTERN	LAST_CC_NUM
	EXTERN	LAST_CC_VALUE
	EXTERN	LAST_PC_NUM
; Outbound MIDI byte
	EXTERN	OUTBOUND_BYTE
; SysEx Message Identifier
	EXTERN	SYSEX_TYPE
; Indiret Addressing Register
	EXTERN	INDIRECT_POINTER
; NULL Register for bad register address ops
	EXTERN	NULL_REGISTER

; STATE_FLAGS
; Various flags for operation
; Bit - Meaning
; 0 - Inbound Message Incomplete
; 1 - Sysex Header Relevant
; 2 - Input processing registers munged
; 3 - Firmware Update Mode (isr selector)
; 4 - Analog Data Valid
; 5 - External Reference Voltage
; 6 - CONFIG Transition (TT = 0 or 1)
; 7 - Sync Run State (0 = stopped, 1 = running)
	EXTERN	STATE_FLAGS

; STATE_FLAGS_2
; Various flags for operation
; Bit - Meaning
; 0 - Active Sense On/Off
	EXTERN	STATE_FLAGS_2

; Pointer to transpose value
	EXTERN	TRANSPOSE_REG

; More temp regs
	EXTERN	TEMP7
	EXTERN	TEMP2_SNAPSHOT
	EXTERN	TEMP3_SNAPSHOT
	EXTERN	TEMP4_SNAPSHOT

; message throttling
	EXTERN	MESSAGE_THROTTLE
	EXTERN	MESSAGE_THROTTLE_COUNTER
	EXTERN	MESSAGE_THROTTLE_COUNTER_2

; Register Config
	EXTERN	REG_ADDRESS
	EXTERN	REG_MIN
	EXTERN	REG_MAX
	EXTERN	REG_RR

; LED Stuff
	EXTERN	LED_UPDATE_SELNUM
	EXTERN	LED_UPDATE_SELBIT
	EXTERN	LED_DATA_FLAGS
	EXTERN	LED_SELECT_FLAGS
	EXTERN	LED_DATA_0
	EXTERN	LED_DATA_1
	EXTERN	LED_DATA_2
	EXTERN	LED_DATA_3
	EXTERN	LED_DATA_4
	EXTERN	LED_DATA_5
	EXTERN	LED_DATA_6
	EXTERN	LED_DATA_7

	EXTERN	LED_REFRESH_BIT
	EXTERN	LED_REFRESH_NUM

; Counter to scale Timer 2
	EXTERN	T2_COUNTER

	EXTERN	PCLATH_STORAGE

	EXTERN	INBOUND_STATUS
	EXTERN	OUTBOUND_STATUS
	EXTERN	INBOUND_BYTECOUNT
	EXTERN	COUNTER_H
	EXTERN	COUNTER_L
	EXTERN	ANALOG_INPUT
	EXTERN	TEMP5
	EXTERN	TEMP6

; MIDI Receive Buffer
	EXTERN	RX_MIDI_BYTE
	EXTERN	RX_BUFFER_HEAD
	EXTERN	RX_BUFFER_TAIL
	EXTERN	RX_BUFFER_GAUGE
	EXTERN	RX_BUFFER

; Common-use variables accessible from any bank
	EXTERN	W_STORAGE
	EXTERN	FSR_STORAGE
	EXTERN	STATUS_STORAGE
	EXTERN	TEMP		
	EXTERN	TEMP2		
	EXTERN	TEMP3		
	EXTERN	TEMP4		
	EXTERN	CONFIG_MODE	
	EXTERN	CONFIG_CHANNEL
	EXTERN	CONFIG_D0	
	EXTERN	CONFIG_D1	
	EXTERN	OUTPUT_COUNTER
	EXTERN	CONFIG_LAYER
	EXTERN	TEMP_REG
	EXTERN	BITMASK		
; temp IM for use with non-interrupt code only
	EXTERN	TEMP_IM		

; Bank 1 variables
	EXTERN	FIRMWARE_BUFFER
	EXTERN	ANALOG_THRESHOLD
	EXTERN	MATRIX_VELOCITY_X
	EXTERN	INCOMING_SYSEX_A

; Bank 2 variables
	EXTERN	SYSEX_YY	
	EXTERN	SYSEX_NN	
	EXTERN	SYSEX_TT	
	EXTERN	SYSEX_MM	
	EXTERN	SYSEX_CH	
	EXTERN	SYSEX_D0	
	EXTERN	SYSEX_D1	

	EXTERN	ANALOG_CN_GATES_0
	EXTERN	ANALOG_CN_GATES_1
	EXTERN	ANALOG_CN_GATES_2
	EXTERN	ENCODER_CN_GATES_0
	EXTERN	ENCODER_CN_GATES_1
	EXTERN	ENCODER_CN_GATES_2
	EXTERN	ANALOG_CN_NOTES_0
	EXTERN	ANALOG_CN_NOTES_1
	EXTERN	ANALOG_CN_NOTES_2
	EXTERN	ENCODER_CN_NOTES_0
	EXTERN	ENCODER_CN_NOTES_1
	EXTERN	ENCODER_CN_NOTES_2

	EXTERN	CC_ON_VALUE_X
	EXTERN	CC_OFF_VALUE_X

	EXTERN	INCOMING_SYSEX_B

; Bank 3 variables
	EXTERN	KEY_TOGGLES	
	EXTERN	LOGIC_TOGGLES_0
	EXTERN	LOGIC_TOGGLES_1
	EXTERN	LOGIC_TOGGLES_2
	EXTERN	INCOMING_SYSEX_C


; =================================
;
; Constants
;
; =================================

INDIRECT_ADDRESS	equ	0x2A
NULL_ADDRESS		equ	0x2A
T2_SCALE		equ	0x08
RX_BUFFER_SIZE	equ	D'8'
RX_POINTER_MASK	equ	B'00000111'
MAX_REGISTER	equ	0x29

SYSEX_MAX_YY	equ	0x03
SYSEX_MAX_NN	equ	0x17
SYSEX_MAX_TT	equ	0x01
SYSEX_MAX_TYPE	equ	0x7F

; types of sysex config messages.  type byte follows device id.
SYSEX_DUMP				equ	0x00
SYSEX_CT_CONFIG			equ	0x01
SYSEX_MATRIX_VELOCITY	equ	0x02
SYSEX_CC_ON				equ	0x03
SYSEX_ENCODER_INIT		equ	0x04
SYSEX_NOTE_MAP			equ	0x05
SYSEX_NOTE_MAP_RESET	equ	0x06
SYSEX_DATA_BUFFER		equ	0x07
SYSEX_ANALOG_THRESHOLD	equ	0x08

; =================================
;
; EEPROM address constants
;
; =================================

PROM_VERSION		equ	0x00
PROM_CHECKSUM		equ	0x01
PROM_ANALOG_THRESHOLD	equ	0x03
PROM_ANALOG_SMOOTHING	equ	0x04
PROM_VREF		equ	0x05
PROM_MATRIX_VELOCITY	equ	0x06
PROM_CC_ON		equ	0x07
PROM_CC_OFF		equ	0x08
PROM_ACTIVE_SENSE	equ	0x09
PROM_REGISTER_INIT	equ	0x0A
PROM_REGISTER_MIN	equ	0x23
PROM_REGISTER_MAX	equ	0x4A
PROM_MESSAGE_THROTTLE	equ	0x7B
PROM_PULLUPS_H		equ	0x7C
PROM_PULLUPS_L		equ	0x7D
PROM_TRANSPOSE_REG	equ	0x7E
PROM_REMAP_FLAGS	equ	0x7F
PROM_NOTE_MAP		equ	0x80

; help for handling register setup info
NUM_MINMAX_REGS		equ	D'39'

